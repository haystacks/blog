---
title: èœå•è®¾è®¡
date: 2019-03-04 10:00:00
tags:
    - éå­¦å‰ç«¯
    - Tree

categories:
    - å­¦ä¹ 
---

## ç›®å½•
- å†…å­˜ç®¡ç† Memory Management
- ä»€ä¹ˆæ˜¯å †æ ˆé˜Ÿåˆ— Heap Stack Quene
    * æ ˆ
    * å †
    * é˜Ÿåˆ—
- ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶
- javascript æ•°æ®ç»“æ„
- å†…å­˜åœ°å€ä¸å†…å­˜ç©ºé—´
- æ‰å¹³åŒ–èœå•è®¾è®¡
- æ ‘çŠ¶ç»“æ„èœå•ç”Ÿæˆ

## å†…å­˜ç®¡ç†
[Memory Management](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management)
Javascript åˆ›å»ºå˜é‡æ—¶åˆ†é…å†…å­˜ï¼Œä¸ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨è¢«åƒåœ¾å›æ”¶ã€‚  
* å¼•ç”¨è®¡æ•°
* æ ‡è®°æ¸…é™¤


## ä»€ä¹ˆæ˜¯å †æ ˆé˜Ÿåˆ—

### æ ˆ
æ ˆæ•°æ®ç»“æ„çš„è®¿é—®è§„åˆ™æ˜¯ LIFOï¼ˆLast-In-First-Outï¼‰åè¿›å…ˆå‡º
```javascript
let colors = new Array();
let len = colors.push('red', 'orange');
console.log(len); // 2
len = colors.push('yellow');
console.log(len); // 3
const item = colors.pop();
console.log(item, colors.length); // yellow 2
```

### å †
```javascript

```

### é˜Ÿåˆ—
å †æ•°æ®ç»“æ„çš„è®¿é—®è§„åˆ™æ˜¯ FIFOï¼ˆFirst-In-First-Outï¼‰å…ˆè¿›å…ˆå‡º
```javascript
// example 1
let colors = new Array();
let len = colors.push('red', 'orange');
console.log(len); // 2
len = colors.push('yellow');
console.log(len); // 3
const item = colors.shift();
console.log(item, colors.length); // red 2

// example 2
let colors = new Array();
let len = colors.push('red', 'orange');
console.log(len); // 2
len = colors.unshift('yellow');
console.log(len); // 3
const item = colors.pop();
console.log(item, colors.length); // orange 2

// example 3 (Proxy)

const Stack = function() {
    return new Proxy([], {
        get(target, name) {
            return target[name];
        }
    })
}

// TODO: æ‰©å±• Proxy çš„åº”ç”¨ Cookie Storage Fetch Ajax
// https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy
// https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie
```

## è¿è¡Œæ—¶

```javascript
async function async1() {
    console.log('async1 start')
    await async2()
    console.log('async1 end')
}
async function async2() {
    console.log('async2')
}
console.log('script start')
setTimeout(function () {
    console.log('setTimeout')
}, 0)
async1();
new Promise(function (resolve) {
    console.log('promise1')
    resolve();
}).then(function () {
    console.log('promise2')
})
console.log('script end')
```
è¿™é“é¢˜æ¶‰åŠ setTimeout Promise Async Await è¿è¡Œæ—¶å †æ ˆå’Œ microtasks macrotasks

## javascript çš„æ•°æ®ç±»å‹å’Œæ•°æ®ç»“æ„
[javascript çš„æ•°æ®ç±»å‹å’Œæ•°æ®ç»“æ„](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures) ä¸­æœ‰å¾ˆè¯¦ç»†çš„æè¿°ã€‚  

### åŠ¨æ€ç±»å‹è¯­è¨€
JavaScript æ˜¯å¼±è¯­è¨€ä¹Ÿå«ç€åŠ¨æ€è¯­è¨€ï¼Œä¸éœ€è¦æå‰ç”³æ˜å˜é‡ç±»å‹ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ç¡®å®šç±»å‹ã€‚  
```javascript
let a = 123;
a = 'abc';
a = false;
console.log(a); // false
```

```typescript
// ç±»å‹æ£€æµ‹
let a: Number = 123;
a = 'abc'; // Error: Type '"abc"' is not assignable to type 'Number'.
```

### æ•°æ®ç±»å‹
ECMAScript å®šä¹‰äº† 7 ç§æ•°æ®ç±»å‹
* åŸºæœ¬ç±»å‹
    * Null
    * Undefined
    * Boolean
    * String
    * Number
    * Symbol
* å¼•ç”¨ç±»å‹
    * Object

**ç±»å‹åˆ¤æ–­**
typeof å¯ä»¥åˆ¤æ–­åŸºæœ¬ç±»å‹ï¼Œä½†æ˜¯ typeof null è¿”å›çš„æ˜¯ objectï¼Œtypeof function() {} è¿”å›çš„æ˜¯ functionã€‚  
instanceof åˆ¤æ–­å®ä¾‹ä¸æ„é€ å‡½æ•°çš„å…³ç³»ã€‚  
```javascript
cosnt boolean = variable instanceof constructor;
```

**ä¸åŒç‚¹**  

1. åªèƒ½ç»™å¼•ç”¨ç±»å‹åŠ¨æ€æ·»åŠ å±æ€§
    ```javascript
    // example 1
    let person = new Object();
    person.name = 'unofficial';
    console.log(person.name); // unofficial

    // example 2
    let name = 'unofficial';
    name.age = 1; // è¿™é‡Œnameåˆ¤æ–­ä¸ºåŸºæœ¬ç±»å‹ï¼Œä¼šæ‰§è¡Œä¸€ä¸ª new String(name) åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¼•ç”¨ç±»å‹ï¼Œç„¶åæ·»åŠ ä¸€ä¸ª age å±æ€§ï¼Œæ‰€ä»¥å®é™…èµ‹å€¼è¿‡ç¨‹ä¸­ä¸ä¼šæŠ¥é”™
    console.log(name.age); // undefined

    // example 3
    let name = new String('unofficial');
    name.age = 1;
    console.log(name.age); // 1
    ```
2. åŸºæœ¬ç±»å‹å¤åˆ¶çš„æ˜¯å€¼ï¼Œä¼šåœ¨å˜é‡å¯¹è±¡ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„å€¼ï¼›å¼•ç”¨ç±»å‹å¤åˆ¶çš„æ˜¯å¼•ç”¨å…³ç³»
    ```javascript
    // example 1
    let a = 1;
    let b = a;
    a = a + 1;
    console.log(a, b); // 2, 1

    // example 2
    let person = {};
    let person1 = person; // å¤åˆ¶å¼•ç”¨ç±»å‹çš„æ—¶å€™å¤åˆ¶çš„æ˜¯å¼•ç”¨å…³ç³»
    person.name = 'unofficial';
    console.log(person.name, person1.name); // unofficial, unofficial
    // åç»­ç»§ç»­æ·±å…¥å­¦ä¹  æ·±æ‹·è´å’Œæµ…æ‹·è´ =>>> å‚è€ƒéå­¦å‰ç«¯-é™„å½•æ·±æ‹·è´å’Œæµ…æ‹·è´
    ```

3. å‡½æ•°ä¸­ä¼ é€’å‚æ•°éƒ½æ˜¯æŒ‰ç…§éƒ½æ˜¯æŒ‰ç…§å€¼ä¼ é€’
    ```javascript
    // example 1
    let a = 1;
    function foo(a) {
        // foo å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œåœ¨é‡Œé¢ä¼šæœ‰ä¸€ä¸ªå±€éƒ¨å¯¹è±¡ arguments ã€‚a ä¼šè¢«èµ‹å€¼ä¸ºä¸€ä¸ªå±æ€§å€¼ï¼Œç±»ä¼¼åŸºæœ¬ç±»å‹å€¼çš„å¤åˆ¶

        return ++a;
    }
    console.log(a, foo(a), a); // 1, 2, 1

    // example 2
    let a = 1;
    function foo() {
        // å½“å‰ä½œç”¨åŸŸæ‰¾ä¸åˆ°å¯¹äº a çš„å®šä¹‰ï¼Œä¼šç»§ç»­å‘çˆ¶çº§ä½œç”¨åŸŸæŸ¥æ‰¾ aã€‚æ‰¾åˆ°åè‡ªåŠ ï¼Œä¿®æ”¹çš„æ˜¯çˆ¶çº§ä½œç”¨åŸŸçš„ aã€‚
        return ++a;
    }
    console.log(a, foo(), a); // 1, 2, 2

    // example 3 ã€***ã€‘
    let a = {
        age: 1
    };
    function foo(a) {
        // è¿™é‡Œçš„ a è¢«èµ‹å€¼ç»™äº†å±€éƒ¨å¯¹è±¡ arguments(è¿˜æ˜¯è¯´ arguments[0] èµ‹å€¼ç»™ a ? )ï¼Œå¯¹è±¡çš„èµ‹å€¼å…¶å®åªæ˜¯å¼•ç”¨å…³ç³»çš„èµ‹å€¼ï¼Œä¿®æ”¹å€¼ä¼šç›´æ¥ä¿®æ”¹åŸå¯¹è±¡ä¸­å€¼ã€‚
        console.log(arguments[0] === a); // true

        // è¿™é‡Œå› ä¸ºè¿˜æ˜¯å¼•ç”¨ç±»å‹çš„å…³ç³»ï¼Œè‡ªåŠ ä»¥åä¼šå½±å“åˆ°åŸå¯¹è±¡
        a.age++;

        // ğŸ¦ ğŸ¥š è®©å®ƒå¿«é€Ÿæˆå¹´ï¼Œè¿™é‡Œå› ä¸º a åœ¨æ ˆå¸§ä¸­åšä¸ºå±€éƒ¨å˜é‡ä»¥åï¼Œé‡æ–°ä¸ºå±€éƒ¨å˜é‡ a åˆ†é…äº†å˜é‡ï¼Œæ”¹å˜äº†å¼•ç”¨åœ°å€ï¼ŒæŒ‡å‘äº†æ–°çš„å†…å­˜ç©ºé—´
        a = {
            age: 18
        };

        console.log(arguments[0] === a); // true
        return ++a.age;
    }
    console.log(a.age, foo(a), a.age); // 1, 19, 2
    ```
## æ‰å¹³åŒ–èœå•è®¾è®¡
æ•°æ®çš„å­˜å‚¨æˆ–è€…ä¿®æ”¹å°½é‡åªæ¶‰åŠåˆ°å½“å‰æ•°æ®ã€‚  

### æ‰å¹³æ•°æ®
åœ¨ä¸šä½™é¡¹ç›®ä¸­æˆ‘çš„ã€Š[GraphQLå­¦ä¹ è¿‡ç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„](https://blog.unofficial.cn/2019/02/18/éå­¦å‰ç«¯-é™„å½•graphql/)ã€‹ï¼Œå…¶ä¸­èœå•éƒ¨åˆ†æ•°æ®åœ¨ mongodb ä¸­ä»¥æ‰å¹³åŒ–çš„å½¢å¼å­˜æ”¾æ•°æ®ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ç”Ÿæˆæ ‘çŠ¶ç»“æ„è¿”å›ç»™å‰ç«¯ã€‚  
æ·»åŠ ä¸€ä¸ªæ–°çš„èœå•é¡¹ç›®æˆ‘ä»¬æäº¤çš„æ•°æ®ä¾‹å¦‚ä¸‹é¢è¿™æ ·ã€‚  
```json
{
    "name": "èœå•åç§°"
}
```
æœåŠ¡ç«¯æ‹¿åˆ°æ•°æ®ä»¥åæ£€æµ‹æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨ id ã€pid ï¼Œæ–°å¢ id æœåŠ¡ç«¯æŒ‰ç…§è§„åˆ™ç”Ÿæˆæˆ–è€…æ•°æ®åº“è‡ªå¢ã€‚pid ä¸ºä¸Šçº§èœå•çš„ idï¼Œä¸å­˜åœ¨é»˜è®¤ä¸ºç©ºå­˜æ”¾è¿›å…¥æ•°æ®åº“ä¸­ã€‚  
```js
[
    ...
    ,
    {
        "id": 1009,
        "name": "èœå•åç§°",
        "pid": null
    }
]
```
ç»™èœå•åç§°æ·»åŠ ä¸€ä¸ªå­èœå•åç§°æ‹¿åˆ°çš„æ•°æ®åº”è¯¥å°±æ˜¯  
```js
[
    ...
    ,
    {
        "id": 1009,
        "name": "èœå•åç§°",
        "pid": null
    }
    ,
    {
        "id": 1010,
        "name": "å­èœå•åç§°",
        "pid": 1009
    }
]
```

### æ ‘ç»“æ„
æŠŠä¸Šé¢çš„æ•°æ®éœ€è¦å¤„ç†æˆæ ‘ç»“æ„ï¼Œä¸ºæ¯ä¸€é¡¹æ·»åŠ ä¸€ä¸ª children ï¼ŒæœŸæœ›å¾—åˆ°å¦‚ä¸‹ç»“æœã€‚  
```js
[
    ...
    ,
    {
        "id": 1009,
        "name": "èœå•åç§°",
        "pid": null,
        "children": [
            {
                "id": 1010,
                "name": "å­èœå•åç§°",
                "pid": 1009,
                "children": []
            }
        ]
    }
]
```

## æ ‘çŠ¶ç»“æ„èœå•ç”Ÿæˆ
äº†è§£äº†èœå•çš„æ‰å¹³è®¾è®¡ä»¥åŠæ˜ç¡®äº†æˆ‘ä»¬éœ€è¦å¾—åˆ°çš„æ ‘çŠ¶ç»“æ„æ•°æ®ï¼Œå¦‚ä½•æ‰èƒ½ç”Ÿæˆè¿™æ ·çš„æ ‘çŠ¶ç»“æ„å‘¢ï¼Ÿ  
è¿™ä¸ªè¿‡ç¨‹éœ€è¦éå†æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„æ•°ç»„ menus ï¼Œå­˜å…¥æ–°çš„æ•°ç»„ä¸­ newMenus ã€‚newMenus ä¸­çš„æ•°æ®å®é™…åªæ˜¯å­˜æ”¾çš„å†…å­˜åœ°å€ï¼Œå®é™…æŒ‡å‘çš„å†…å­˜ç©ºé—´å’Œ menus æ˜¯ç›¸åŒçš„ã€‚  

```javascript
const menus = [
    {
        name: 'èœå•åç§°'
    }
];

const menu = menus[0];
menus[0].name = 'èœå•';
console.log(menu.name); // èœå•
```

éå† menus çš„è¿‡ç¨‹ä¸­å¦‚æœ pid ä¸º nullï¼Œæˆ‘ä»¬æŠŠæ•°æ®å­˜å…¥ newMenusï¼Œå¦‚æœ pid ä¸ä¸ºç©ºï¼Œæˆ‘ä»¬æ‰¾åˆ° id ç­‰äº pid çš„æ•°æ®ç»™å®ƒæ·»åŠ ä¸Š children ã€‚  
ä¸ºäº†æ–¹ä¾¿åœ¨éå†çš„è¿‡ç¨‹ä¸­è½»æ¾æ‰¾åˆ° id ç­‰äº pid çš„æ•°æ®ï¼Œæˆ‘ä»¬ä»¥ id ä¸º key äº§ç”Ÿä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚  

```javascript
let map = {};
menus.forEach(item => {
    const key = item.id; // ä»¥ id ä¸º key
    map[key] = item;
})
```

éå† menus æ•°ç»„è·å¾—æ–°çš„æ•°ç»„ newMenus  

```javascript
let newMenus = [];
menus.forEach(item => {
    if (item.pid) {
        const key = item.pid; // æ‰¾åˆ° id ç­‰äº pid çš„æ•°æ®
        // å› ä¸º children æ˜¯æ–°å¢çš„ï¼Œå¯èƒ½å­˜åœ¨ï¼Œå¯èƒ½ä¸å­˜åœ¨
        (map[key].children || (map[key].children = [])).push(item);
    } else {
        newMenus.push(item);
    }
})
```

menus map newMenus ä»–ä»¬å…¶å®æ˜¯æŒ‡å‘çš„ç›¸åŒå†…å­˜ç©ºé—´ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ menus ä¸­çš„ name ï¼Œmap ã€ newMenus ä¸­å¯¹äºæ•°æ®çš„ name ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚  

### æ·±æµ…æ‹·è´

### 


### å‚è€ƒèµ„æ–™

http://blog.leapoahead.com/2015/09/15/js-closure/
https://dmitryfrank.com/articles/js_closures?utm_source=javascriptweekly&utm_medium=email
https://developer.mozilla.org/zh-CN/docs/Web/
https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/?utm_source=html5weeklyJavaScript/EventLoop
https://www.youtube.com/watch?v=8aGhZQkoFbQ